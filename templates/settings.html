<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiln Settings</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            color: #eee;
            margin: 0;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #1e1e1e;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 2rem;
            color: #fff;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            background-color: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .label {
            color: #9ca3af;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select {
            background-color: #1a1a1a;
            color: #eee;
            border: 1px solid #444;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 1rem;
            outline: none;
            cursor: pointer;
        }

        select:focus {
            border-color: #3b82f6;
        }

        .nav-links {
            margin-top: 2rem;
            text-align: center;
        }

        a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        a:hover {
            text-decoration: underline;
        }

        .status-msg {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            height: 1rem;
            transition: opacity 0.3s;
        }

        .status-msg.success {
            color: #10b981;
        }

        .status-msg.error {
            color: #ef4444;
        }

        @media (max-width: 600px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Kiln Settings</h1>

        <div class="settings-grid">
            {% for enum_name, enum_class in enums.items() %}
            <div class="setting-item">
                <span class="label">{{ enum_name | replace('Setting', '') | replace('Selection', '') | replace('Status',
                    '') | title }}</span>
                {% set setting_key = enum_name[0]|lower + enum_name[1:] %}
                {# Attempt to match enum name to settings key #}
                {# We need a mapping because the names in settings dict are snake_case #}

                {% if enum_name == "ControlMethod" %}{% set key = "control_method" %}
                {% elif enum_name == "HeatingCoolingSelection" %}{% set key = "heating_cooling" %}
                {% elif enum_name == "SystemAlarmSetting" %}{% set key = "system_alarm" %}
                {% elif enum_name == "SettingLockStatus" %}{% set key = "lock_status" %}
                {% elif enum_name == "PIDParameterSelection" %}{% set key = "pid_selection" %}
                {% elif enum_name == "AnalogDecimalSetting" %}{% set key = "analog_decimal" %}
                {% elif enum_name == "ValveFeedbackSetting" %}{% set key = "valve_feedback" %}
                {% elif enum_name == "AutoTuningValveFeedback" %}{% set key = "at_valve_feedback" %}
                {% elif enum_name == "TempUnit" %}{% set key = "temp_unit" %}
                {% elif enum_name == "DecimalPointPosition" %}{% set key = "decimal_point" %}
                {% elif enum_name == "ATSetting" %}{% set key = "at_setting" %}
                {% elif enum_name == "RunStopSetting" %}{% set key = "run_stop" %}
                {% elif enum_name == "StopSettingPID" %}{% set key = "stop_pid" %}
                {% elif enum_name == "TemporarilyStopPID" %}{% set key = "temp_stop_pid" %}
                {% endif %}

                <select name="value" hx-post="/settings/update/{{ key }}" hx-trigger="change" hx-swap="none"
                    onchange="showStatus(this)">
                    {% for member in enum_class %}
                    <option value="{{ member.value }}" {% if settings[key]==member.value %}selected{% endif %}>
                        {{ member.name | replace('_', ' ') | title }}
                    </option>
                    {% endfor %}
                </select>
                <div id="status-{{ key }}" class="status-msg"></div>
            </div>
            {% endfor %}

            <div class="setting-item">
                <span class="label">Sensor Type</span>
                <input type="number" name="value" value="{{ settings.sensor_type }}"
                    hx-post="/settings/update/sensor_type" hx-trigger="change" hx-swap="none"
                    style="background: #1a1a1a; color: #eee; border: 1px solid #444; padding: 0.5rem; border-radius: 4px;"
                    onchange="showStatus(this)">
                <div id="status-sensor_type" class="status-msg"></div>
            </div>
        </div>

        <div class="nav-links">
            <a href="/">Back to Dashboard</a>
        </div>
    </div>

    <script>
        function showStatus(el) {
            const name = el.getAttribute('hx-post').split('/').pop();
            const statusEl = document.getElementById('status-' + name);
            if (!statusEl) return;

            statusEl.textContent = 'Saving...';
            statusEl.className = 'status-msg';
            statusEl.style.opacity = '1';

            document.body.addEventListener('htmx:afterRequest', function (evt) {
                if (evt.detail.pathInfo.requestPath.endsWith(name)) {
                    if (evt.detail.successful) {
                        statusEl.textContent = 'Saved';
                        statusEl.className = 'status-msg success';
                        setTimeout(() => {
                            statusEl.style.opacity = '0';
                        }, 2000);
                    } else {
                        statusEl.textContent = 'Error';
                        statusEl.className = 'status-msg error';
                    }
                }
            }, { once: true });
        }
    </script>
</body>

</html>