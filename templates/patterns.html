<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta DTB Pattern Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            color: #eee;
            margin: 0;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: #1e1e1e;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        h1 {
            color: #fff;
            margin-top: 0;
            margin-bottom: 2rem;
            font-weight: 600;
            text-align: center;
        }

        #chart-container {
            position: relative;
            height: 50vh;
            width: 100%;
        }

        .status-box {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #252525;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .status-item span.label {
            color: #9ca3af;
            font-size: 0.875rem;
            display: block;
        }

        .status-item span.value {
            color: #fff;
            font-weight: 500;
            font-size: 1.125rem;
        }

        .error-msg {
            color: #ef4444;
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        .nav-links {
            margin-top: 1.5rem;
            display: block;
            text-align: center;
        }

        a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Pattern Visualization</h1>

        <div class="status-box">
            <div class="status-item">
                <span class="label">Pattern Selection</span>
                <select id="pattern-select"
                    style="background: #333; color: #fff; border: 1px solid #555; padding: 4px; border-radius: 4px;">
                    <option value="0">Pattern 0</option>
                    <option value="1">Pattern 1</option>
                    <option value="2">Pattern 2</option>
                    <option value="3">Pattern 3</option>
                    <option value="4">Pattern 4</option>
                    <option value="5">Pattern 5</option>
                    <option value="6">Pattern 6</option>
                    <option value="7">Pattern 7</option>
                </select>
            </div>
            <div class="status-item">
                <span class="label">Total Steps</span>
                <span class="value" id="total-steps">--</span>
            </div>
            <div class="status-item">
                <span class="label">Total Duration</span>
                <span class="value" id="total-duration">-- min</span>
            </div>
        </div>

        <div id="chart-container">
            <canvas id="patternChart"></canvas>
        </div>
        <div id="error-msg" class="error-msg"></div>

        <div class="nav-links">
            <a href="/">Back to Dashboard</a>
        </div>
    </div>

    <!-- 
      Note for Pattern Visualization:
      HTMX is excellent for swapping HTML, but Chart.js canvas rendering relies heavily on Client-Side JS data.
      To satisfy "using jinja2 and htmx", we serve this page via Jinja, and utilize HTMX for navigation links.
      The chart logic remains in JS for best interactivity and performance.
    -->
    <script>
        const API_BASE = ''; // Relative path since we are on the same server
        let chartInstance = null;
        const patternSelect = document.getElementById('pattern-select');

        // Event Listener for changing pattern
        patternSelect.addEventListener('change', (e) => {
            loadPattern(e.target.value);
        });

        async function init() {
            try {
                // 1. Get Current Program to set initial selection
                const progResponse = await fetch(`${API_BASE}/current/program`);
                if (!progResponse.ok) throw new Error('Failed to fetch current program');
                const progData = await progResponse.json();

                const currentPatternId = progData.pattern;
                patternSelect.value = currentPatternId;

                // 2. Load data for that pattern
                loadPattern(currentPatternId);

            } catch (error) {
                console.error(error);
                showError(`Error initializing: ${error.message}. Is server running?`);
            }
        }

        async function loadPattern(patternId) {
            try {
                const patternResponse = await fetch(`${API_BASE}/pattern/${patternId}`);
                if (!patternResponse.ok) throw new Error(`Failed to fetch pattern ${patternId}`);
                const patternData = await patternResponse.json();

                renderChart(patternData.steps);
                hideError();
            } catch (error) {
                console.error(error);
                showError(`Error loading pattern ${patternId}: ${error.message}`);
            }
        }

        function showError(msg) {
            const errDiv = document.getElementById('error-msg');
            errDiv.innerText = msg;
            errDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-msg').style.display = 'none';
        }

        function renderChart(steps) {

            const labels = []; // Time points
            const dataPoints = []; // Temp points

            // Initial Point
            let currentTime = 0;
            let currentTemp = 25; // Default start

            labels.push(currentTime);
            dataPoints.push(currentTemp);

            steps.forEach(step => {
                const duration = step.time;
                const targetTemp = step.temp;

                if (duration > 0 || (step.step === 7 && duration === 0)) {
                    currentTime += duration;
                    labels.push(currentTime);
                    dataPoints.push(targetTemp);
                }
            });

            document.getElementById('total-steps').innerText = steps.length;
            document.getElementById('total-duration').innerText = currentTime;

            // Destroy existing chart if any
            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.getElementById('patternChart').getContext('2d');

            // Gradient Fill
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Blue 500
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: dataPoints,
                        borderColor: '#3b82f6', // Blue 500
                        backgroundColor: gradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#1e1e1e', // Match card bg
                        pointBorderColor: '#60a5fa', // Blue 400
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.1 // Slight curve
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#374151',
                            titleColor: '#e5e7eb',
                            bodyColor: '#e5e7eb',
                            borderColor: '#4b5563',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Time (minutes)',
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature (°C)',
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            },
                            ticks: {
                                color: '#9ca3af'
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Run on load
        init();
    </script>
</body>

</html>