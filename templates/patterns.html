<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta DTB Pattern Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/chart_utils.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            color: #eee;
            margin: 0;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: #1e1e1e;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        h1 {
            color: #fff;
            margin-top: 0;
            margin-bottom: 2rem;
            font-weight: 600;
            text-align: center;
        }

        #chart-container {
            position: relative;
            height: 50vh;
            width: 100%;
        }

        .status-box {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #252525;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .status-item span.label {
            color: #9ca3af;
            font-size: 0.875rem;
            display: block;
        }

        .status-item span.value {
            color: #fff;
            font-weight: 500;
            font-size: 1.125rem;
        }

        .error-msg {
            color: #ef4444;
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        .nav-links {
            margin-top: 1.5rem;
            display: block;
            text-align: center;
        }

        a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        a:hover {
            text-decoration: underline;
        }

        .btn-edit {
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            text-decoration: none;
            margin-left: 1rem;
        }

        .btn-edit:hover {
            background-color: #2563eb;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Pattern Visualization</h1>

        <div class="status-box">
            <div class="status-item">
                <span class="label">Pattern Selection</span>
                <div style="display: flex; align-items: center;">
                    <select id="pattern-select"
                        style="background: #333; color: #fff; border: 1px solid #555; padding: 4px; border-radius: 4px;">
                        <option value="0">Pattern 0</option>
                        <option value="1">Pattern 1</option>
                        <option value="2">Pattern 2</option>
                        <option value="3">Pattern 3</option>
                        <option value="4">Pattern 4</option>
                        <option value="5">Pattern 5</option>
                        <option value="6">Pattern 6</option>
                        <option value="7">Pattern 7</option>
                    </select>
                    <button class="btn-edit" onclick="goToEdit()">Edit</button>
                </div>
            </div>
            <div class="status-item">
                <span class="label">Total Steps</span>
                <span class="value" id="total-steps">--</span>
            </div>
            <div class="status-item">
                <span class="label">Total Duration</span>
                <span class="value" id="total-duration">-- min</span>
            </div>
        </div>

        <div id="error-msg" class="error-msg"></div>
        <div id="chart-container">
            <canvas id="patternChart"></canvas>
        </div>


        <div class="nav-links">
            <a href="/">Back to Dashboard</a>
        </div>
    </div>

    <!-- 
      Note for Pattern Visualization:
      HTMX is excellent for swapping HTML, but Chart.js canvas rendering relies heavily on Client-Side JS data.
      To satisfy "using jinja2 and htmx", we serve this page via Jinja, and utilize HTMX for navigation links.
      The chart logic remains in JS for best interactivity and performance.
    -->
    <script>
        const API_BASE = ''; // Relative path since we are on the same server
        const patternSelect = document.getElementById('pattern-select');
        const patternChart = new PatternChart('patternChart');

        // Init Diagram
        patternChart.init(false); // No current temp line for this view

        const totalStepsEl = document.getElementById('total-steps');
        const totalDurationEl = document.getElementById('total-duration');
        let currentPatternId = 0;

        // Event Listener for changing pattern
        patternSelect.addEventListener('change', (e) => {
            currentPatternId = parseInt(e.target.value);
            loadPattern(currentPatternId);
        });

        async function init() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const selectedParam = urlParams.get('selected');

                let targetPatternId;

                if (selectedParam !== null) {
                    // Use the query parameter if present
                    targetPatternId = parseInt(selectedParam);
                } else {
                    // Otherwise fetch current program
                    const progResponse = await fetch(`${API_BASE}/current/program`);
                    if (!progResponse.ok) throw new Error('Failed to fetch current program');
                    const progData = await progResponse.json();
                    targetPatternId = progData.pattern;
                }

                // Set dropdown and load
                patternSelect.value = targetPatternId;
                loadPattern(targetPatternId);

            } catch (error) {
                console.error(error);
                showError(`Error initializing: ${error.message}. Is server running?`);
            }
        }

        async function loadPattern(patternId) {
            try {
                const patternResponse = await fetch(`${API_BASE}/pattern/${patternId}`);
                if (!patternResponse.ok) throw new Error(`Failed to fetch pattern ${patternId}`);
                const patternData = await patternResponse.json();

                // Update stats
                let totalSteps = 0;
                let totalTime = 0;
                patternData.steps.forEach(s => {
                    if (s.time > 0 || (s.step === 7 && s.time === 0)) { // Simple heuristic
                        totalSteps++;
                        totalTime += s.time;
                    }
                });
                totalStepsEl.innerText = totalSteps;
                totalDurationEl.innerText = totalTime + " min";

                // Update Chart
                patternChart.updatePattern(patternData.steps);
                hideError();
            } catch (error) {
                console.error(error);
                showError(`Error loading pattern ${patternId}: ${error.message}`);
            }
        }
        function goToEdit() {
            window.location.href = `/patterns/${patternSelect.value}/edit`;
        }
        function showError(msg) {
            const errDiv = document.getElementById('error-msg');
            errDiv.innerText = msg;
            errDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-msg').style.display = 'none';
        }

        // Run on load
        init();
    </script>
</body>

</html>